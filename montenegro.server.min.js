caterwaul.configuration('montenegro.core',function (){this.shallow('montenegro',{require:require})}).tconfiguration('std seq','montenegro.route.url',function (){this.configure('montenegro.core').montenegro/se[(_.route=_.route||{})/se[_.url()=l*[result(request,response)=result.route(request,response)] in result/se[_.handlers=seq[ ~[]],_.on(pattern,method,handler)=this/se[_.handlers.push({url:pattern,method:method,handler:handler})],_.route(request,response)=this/se[(_.handler_for(request.url,request.method)||_.not_found).call(_,request,response)],_.not_found(request,response)=response/se[_.writeHead(404),_.end('#{request.url} was not found.')],_.service_listing(req,res)=res/se.r[r.writeHead(200),r.end(seq[_.handlers*['#{_.url} (#{_.method})']].join('\n'))],_.handlers_for(url,method)=seq[this.handlers%[(_.url.test?_.url.test(url):_.url===url)&&( !_.method||_.method===method)]*[_.handler]],_.handler_for(url,method)=this.handlers_for(url,method).pop()]]]}).tconfiguration('std seq','montenegro.server',function (){l[require=this.configure('montenegro.core').montenegro.require] in this.configure('montenegro.route.url').montenegro/se[_.server(port)=caterwaul.util.merge(_.route.url(),_.server.extensions)/se[require('http').createServer(_).listen(port||8080,'0.0.0.0')],_.server.extensions={}]}).tconfiguration('std','montenegro.html',function (){this.configure('montenegro.core').montenegro/se[_.html(t)=l*[html_header()=l[s(src)='<script src="#{src}"></script>'] in '<!doctype html><html><head>#{s(_.html.jquery_path)}#{s(_.html.caterwaul_path)}#{s(_.html.montenegro_path)}',wrap_initializer(s)='<script>$(caterwaul.clone("std opt continuation seq parser montenegro")(#{s}))</script>',html_footer()='</head><body></body></html>'] in html_header()+wrap_initializer(qs[function (){return _t}].replace({_t:t}).serialize())+html_footer(),_.html/se[_.caterwaul_path='http://spencertipping.com/caterwaul/caterwaul.all.js',_.montenegro_path='http://spencertipping.com/montenegro/montenegro.client.js',_.jquery_path='http://ajax.googleapis.com/ajax/libs/jquery/1.5.0/jquery.min.js']]}).tconfiguration('std continuation','montenegro.server.rpc',function (){l*[html=this.configure('montenegro.html').montenegro.html] in this.configure('montenegro.server').montenegro.server.extensions/se[_.rpc(url,_documentation,_fn)=this/se.t[install_json_post_handler(t),install_documentation_handler(t),install_test_page(t),where*[documentation=_fn?_documentation:'#{url} service (no documentation provided)',fn=_fn||_documentation,rpc=_.rpc,install_json_post_handler(server)=server.on(url,'POST',fn[req,res][json_from(req)(fn[json][fn.apply(json_to(res),json)])]),install_documentation_handler(server)=server.on('#{url}/doc','GET',fn[req,res][res/se[_.writeHead(200,{'content-type':'text/plain'}),_.end(doc)]]),install_test_page(server)=server.on(url,'GET',fn[req,res][res/se[_.writeHead(200,{'content-type':'text/html'}),_.end(rpc.testpage())]]),json_from(request)(cc)=l[pieces=[]] in request/se[_.on('data',pieces/mb/push),_.on('end',fn_[unwind_protect[rpc.error(e)][cc(JSON.parse(pieces.join('')))]])],error_to(response)(e)=response/se[_.writeHead(400,{'content-type':'text/plain'}),_.end(e.toString())],json_to(response)()=l[as=Array.prototype.slice.call(arguments)] in response/se[_.writeHead(200,{'content-type':'application/json'}),_.end(JSON.stringify(as))]]],_.rpc.error(e)=e/se[console.log(_)],_.rpc.testpage()=html(qs[$('head').append(html[link*rel('stylesheet')*href('http://fonts.googleapis.com/css?family=Droid+Sans+Mono&subset=latin'),link*rel('stylesheet')*href('http://spencertipping.com/montenegro/style/testpage.css')]),$('body').append(html[div(div.header(h1('RPC shell'),h2.documentation(span.loading('loading documentation...'))),p('You can evaluate code below. ',code('rpc()'),' is the RPC connector function for the API, and ',code('log()'),' can be used to log values. Your code will be macroexpanded under std, seq, opt, parser, montenegro, and continuation.'),div(button.run('Run')),textarea.code/val('l/cps[x <- rpc("Hello world", _)][log(x)]'),div.log)]),window.rpc=caterwaul.montenegro.rpc(url),$('.run').click(fn_[unwind_protect[error(e)][caterwaul.clone('std seq continuation opt montenegro')('(function () {#{$("textarea.code").val()}})')()]]),$.get('#{url}/doc',fn[doc][$('.documentation').empty().append(doc)]),where*[entry(x)=html[div.entry(code(x),' ',a('[x]')/click(fn_[$(this).parent().remove()]))],log=window.log(x)=$('div.log').append(entry(JSON.stringify(x))),error=window.error(x)=$('div.log').append(entry(x.toString()).addClass('error')),url=document.location.href]])]}).tconfiguration('std','montenegro.server.html',function (){l[html=this.configure('montenegro.html').montenegro.html] in this.configure('montenegro.server').montenegro.server.extensions/se[_.html(url,t)=l[s=html(t)] in this/se[_.on(url,'GET',fn[req,res][res/se[_.writeHead(200,{'content-type':'text/html'}),_.end(s)]])]]}).tconfiguration('std seq continuation','montenegro.server.proxy',function (){l[http=this.configure('montenegro.core').montenegro.require('http')] in this.configure('montenegro.server').montenegro.server.extensions/se[_.proxy(url,options)=l/cps[(req,res)< -this.on(new RegExp('^#{url}'),null,_)][l[req0=proxy_request_for(req,url)][req.pipe(req0),l/cps[res0< -req0.on('response',_)][res.writeHead(res0.statusCode,res0.headers),res0.pipe(res)]]],where*[parts_for(url)=/^\/?([^:\/]+)(:?\d*)(\/?.*)$/.exec(url),host_for(parts)=parts&&parts[1],port_for(parts)=parts&&Number(parts[2].substring(1))||80,proxy_request_for(req,base_url)=l*[parts=parts_for(req.url.replace(base_url,'')),host=host_for(parts),port=port_for(parts)] in http.createClient(port,host).request(req.method,parts&&parts[3]||'/',caterwaul.util.merge({},req.headers,{host:host}))]]}).tconfiguration('std continuation','montenegro.server.file',function (){l[sanitize(s)=s.replace(/\.\+/g,'.'),fs=this.configure('montenegro.core').montenegro.require('fs')] in this.configure('montenegro.server').montenegro.server.extensions/se.e[e.file_extension_mimetypes={css:'text/css',html:'text/html',js:'application/javascript','':'text/plain'},e.file(url,filename)=this/se[l/cps[(req,res)< -this.on(new RegExp('^#{url.replace(/\/$/, "")}(/|$)'),'GET',_)][req.url=req.url.replace(/\?.*$/,''),res.writeHead(200,{'content-type':content_type_for(req.url)}),read_stream.pipe(res),where[read_stream=fs.createReadStream('#{filename}#{sanitize(req.url.substring(url.length))}'),content_type_for(url)=/\.(\w+)$/.exec(url)/re[_&&_[1]/re[e.file_extension_mimetypes[_]||e.file_extension_mimetypes['']]]]]]]}).tconfiguration('std continuation','montenegro.server.alias',function (){this.configure('montenegro.server').montenegro.server.extensions/se[_.alias(from,to,method)=this/se[_.on(from,method,fn[req,res][_(req/se[_.url=from.test?_.url.replace(from,to):to],res)])],_.redirect(from,to,options)=this/se[l/cps[(req,res)< -this.on(from,options/re[_&&_.method],_)] in res/se[_.writeHead(options/re[_&&_.code]||301,{location:to}),res.end()]]]}).configuration('montenegro',function (){this.configure('montenegro.html montenegro.route.url montenegro.server montenegro.server.rpc montenegro.server.html montenegro.server.file','montenegro.server.alias montenegro.server.proxy')});